@model IEnumerable<CartModel>

@{
    ViewData["Title"] = "Thanh toán";
    decimal total = Model.Sum(c => c.Price * c.Quantity);	
}

<div class="container mt-4">
    <h2>Thanh toán</h2>

    <!-- Bảng giỏ hàng -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Giá</th>
                <th>Mô tả</th>
                <th>Số lượng</th>
                <th>Tạm tính</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Product.NameProduct</td>                   
                    <td>@string.Format("{0:N0} đ", item.Price)</td>
                    <td>@item.Product.Description</td>
                    <td>@item.Quantity</td>
                    <td>@string.Format("{0:N0} đ", item.TotalPrice)</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="form-group">
        <label>Tỉnh thành phố</label>
        <select class="css_select" id="tinh" name="tinh" class="form-control" title="Chọn Tỉnh Thành">
            <option value="0">Tỉnh Thành</option>
        </select>
    </div>

    <div class="form-group">
        <label>Phường xã</label>
        <select class="css_select" id="quan" name="quan" class="form-control" title="Chọn Quận Huyện">
            <option value="0">Phường xã</option>
        </select>
    </div>

    <h4 class="text-end">
        Phí ship: <b id="shipFee">@ViewBag.ShippingPrice đ</b>
    </h4>

    <div class="mb-3">
        <label for="discountSelect" class="form-label">Chọn mã giảm giá:</label>
        <select id="discountSelect" class="form-select">
            <option value="">-- Chọn mã giảm giá --</option>
        </select>
    </div>

    <div id="discountMessage" class="mt-2"></div>

    @if (ViewBag.SelectedDiscount != null)
    {
        <div class="alert alert-success">
            Mã <strong>@ViewBag.SelectedDiscount</strong> được áp dụng - Giảm @ViewBag.DiscountPercent%
        </div>
    }

    <h4 class="text-end">
        Tổng tiền:
        <b id="totalAmount" data-value="@total">
            @total.ToString("N0") đ
        </b>
    </h4>

    <!-- Form thanh toán -->
    <form asp-controller="Checkout" asp-action="PlaceOrder" method="post" class="mt-3">
        <div class="mb-3">
            <label for="paymentMethod" class="form-label">Chọn phương thức thanh toán:</label>
            <select id="paymentMethod" name="paymentMethod" class="form-select" required>
                <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                <option value="Momo">Momo</option>
                <option value="VNPay">VNPay</option>
                <option value="CreditCard">Thẻ tín dụng</option>
            </select>
        </div>

        <!-- Hidden field để gửi DiscountID -->
        <input type="hidden" name="discountId" id="discountId" value="" />

        <button type="submit" class="btn btn-success">Xác nhận thanh toán</button>
    </form>
</div>
@section Scripts {
    <script>
        $("form").on("submit", function(e) {
            e.preventDefault();

            const form = this; // lưu lại form để submit sau

            Swal.fire({
                icon: 'success',
                title: 'Thanh toán thành công!',
                text: 'Cảm ơn bạn đã mua hàng.',
                showConfirmButton: false,
                timer: 2000,
                position: 'center' // chính giữa màn hình
            }).then(() => {
                form.submit(); // gửi form sau khi thông báo kết thúc
            });
        });

        $(document).ready(function () {
            const $discountSelect = $("#discountSelect");
            const $discountMsg = $("#discountMessage");
            const $totalAmount = $("#totalAmount");
            const $shipFee = $("#shipFee");
            const baseTotal = parseFloat($totalAmount.data("value")); // Tổng tiền sản phẩm
            let currentDiscountPercent = 0; // Phần trăm giảm hiện tại
            let currentShippingFee = 0; // Phí ship hiện tại

            // =================== Hàm cập nhật tổng tiền ===================
            function updateTotal() {
                let discountValue = baseTotal * currentDiscountPercent / 100;
                let total = baseTotal + currentShippingFee - discountValue;
                if(total < 0) total = 0;
                $totalAmount.text(total.toLocaleString("vi-VN") + " đ");
            }

            // =================== Load tỉnh thành ===================
            $.getJSON('https://esgoo.net/api-tinhthanh-new/1/0.htm', function (data_tinh) {
                if (data_tinh.error === 0) {
                    $.each(data_tinh.data, function (_, val_tinh) {
                        $("#tinh").append(`<option value="${val_tinh.id}">${val_tinh.full_name}</option>`);
                    });
                }
            });

            // Khi chọn tỉnh -> load quận
            $("#tinh").change(function () {
                const idtinh = $(this).val();
                if (!idtinh) return;

                $.getJSON(`https://esgoo.net/api-tinhthanh-new/2/${idtinh}.htm`, function (data_quan) {
                    if (data_quan.error === 0) {
                        $("#quan").html('<option value="0">Quận Huyện</option>');
                        $.each(data_quan.data, function (_, val_quan) {
                            $("#quan").append(`<option value="${val_quan.id}">${val_quan.full_name}</option>`);
                        });
                    }
                });
            });

            // =================== Khi chọn tỉnh/quận -> tính phí ship ===================
            $("#tinh, #quan").change(function () {
                const tinh = $("#tinh option:selected").text();
                const quan = $("#quan option:selected").text();

                if(!tinh || !quan) {
                    currentShippingFee = 0;
                    $shipFee.text("0 đ");
                    updateTotal();
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("GetShipping", "CheckOut")",
                    data: { tinh: tinh, quan: quan },
                    success: function (res) {
                        if(res && res.shippingPrice !== undefined) {
                            currentShippingFee = parseFloat(res.shippingPrice) || 0;
                            $shipFee.text(currentShippingFee.toLocaleString("vi-VN") + " đ");
                            updateTotal();
                        }
                    },
                    error: function () { Swal.fire("Không lấy được phí ship!"); }
                });
            });

            // =================== Load danh sách mã giảm giá ===================
            $discountSelect.empty().append(`<option value="">-- Chọn mã giảm giá --</option>`);
            $.ajax({
                url: "@Url.Action("GetDiscounts", "CheckOut")",
                type: "GET",
                success: function(res) {
                    if(res.success && res.data && res.data.length > 0) {
                        res.data.forEach(function(item) {
                            $discountSelect.append(`<option value="${item.id}" data-percent="${item.percent}" data-code="${item.code}">${item.text}</option>`);
                        });
                    } else {
                        $discountSelect.append(`<option disabled>Không có mã giảm giá khả dụng</option>`);
                    }
                },
                error: function() {
                    $discountSelect.append(`<option disabled>Lỗi khi tải danh sách mã</option>`);
                }
            });

            // =================== Khi chọn mã giảm giá ===================
            $discountSelect.on("change", function () {
                const selectedId = $(this).val();
                $("#discountId").val(selectedId || ""); // cập nhật hidden field

                if(!selectedId) {
                    currentDiscountPercent = 0;
                    $discountMsg.empty();
                    updateTotal();
                    return;
                }

                $.ajax({
                    url: "@Url.Action("ApplyDiscount", "CheckOut")",
                    type: "GET",
                    data: { discountId: selectedId },
                    success: function(res) {
                        if(res.success) {
                            currentDiscountPercent = parseFloat(res.percent) || 0;
                            updateTotal();
                            $discountMsg.html(`<div class="alert alert-success mt-2">Mã <strong>${res.code}</strong> được áp dụng - Giảm ${currentDiscountPercent}% (${(baseTotal * currentDiscountPercent / 100).toLocaleString("vi-VN")} đ)</div>`);
                        } else {
                            currentDiscountPercent = 0;
                            updateTotal();
                            $discountMsg.html(`<div class="alert alert-danger mt-2">${res.message || "Không thể áp dụng mã giảm giá."}</div>`);
                        }
                    },
                    error: function() {
                        currentDiscountPercent = 0;
                        updateTotal();
                        $discountMsg.html(`<div class="alert alert-danger mt-2">Lỗi khi áp dụng mã giảm giá.</div>`);
                    }
                });
            });
        });
    </script>
}
